# Send Auctions

Многораундовая система аукционов цифровых товаров, вдохновлённая Telegram Gift Auctions.

## Механика аукциона

### Как это работает

1. **Создание аукциона**: Указываются общее количество товаров, товаров за раунд, минимальная ставка и длительность раунда
2. **Ставки**: Пользователи делают ставки из своего баланса. Сумма замораживается сразу
3. **Конец раунда**: Топ N участников (по количеству товаров за раунд) получают товары. Остальные переносятся в следующий раунд
4. **Anti-Sniping**: Ставки в последние 30 секунд продлевают раунд на 30 секунд
5. **Завершение**: После распределения всех товаров оставшиеся ставки возвращаются

### Основные правила

- Одна активная ставка на пользователя на аукцион
- Можно повысить ставку в любой момент (замораживается только разница)
- Победители платят свою ставку
- Проигравшие автоматически переносятся в следующий раунд
- Номера товаров присваиваются по рангу (высшая ставка = товар #1)

### Обработанные edge-cases

- Конкурентные ставки (MongoDB транзакции)
- Продление таймера anti-sniping
- Проверка достаточности баланса
- Race conditions при завершении раунда
- Корректные возвраты при завершении аукциона

## Стек

- Node.js + TypeScript
- Express.js
- MongoDB + Mongoose
- Vanilla JS фронтенд

## Быстрый старт

```bash
npm install
docker-compose up -d mongo
npm run dev
```

Открыть http://localhost:3000

## API Endpoints

### Пользователи
- `POST /api/users` - Создать пользователя
- `GET /api/users?username=xxx` - Найти по username
- `GET /api/users/:id` - Получить пользователя
- `POST /api/users/:id/deposit` - Пополнить баланс

### Аукционы
- `POST /api/auctions` - Создать аукцион
- `GET /api/auctions` - Список всех 
- `GET /api/auctions/active` - Список активных
- `GET /api/auctions/:id` - Получить аукцион
- `GET /api/auctions/:id/state` - Текущее состояние с лидербордом
- `POST /api/auctions/:id/start` - Запустить аукцион
- `POST /api/auctions/:id/finalize` - Принудительно завершить раунд

### Ставки
- `POST /api/bids` - Сделать/повысить ставку
- `GET /api/bids/auction/:id` - Ставки аукциона
- `GET /api/bids/user/:id` - Ставки пользователя

## Нагрузочное тестирование

```bash
npx tsx scripts/bots.ts load <auctionId> 10 3 #десять ботов на 3 раунда ставок
npx tsx scripts/bots.ts snipe <auctionId>
```

## Архитектура

```
src/
├── models/          # MongoDB схемы
├── services/        # Бизнес-логика
│   ├── auction      # Логика аукционов
│   ├── bid          # Операции со ставками
│   ├── user         # Пользователи и баланс
│   ├── round        # Основная логика аукциона
│   └── scheduler    # Автозавершение раундов
├── controllers/     # HTTP обработчики
├── routes/          # Express роуты
└── index.ts         # Точка входа
```

## Лицензия

MIT
